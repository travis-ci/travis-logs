language: ruby
rvm: 2.5.8
dist: bionic

cache:
  bundler: true
  directories:
  - ${HOME}/perl5
  - ${HOME}/.cache

env:
  global:
    - PATH=/snap/bin:$PATH

jobs:
  include:
  - stage: "Testing time"
    services:
    - redis
    - rabbitmq
    addons:
      postgresql: 11
    before_install:
    - script/install-sqitch
    - eval "$(perl -I ~/perl5/lib/perl5/ '-Mlocal::lib')"
    before_script:
      #- docker run -d --rm -P -p 127.0.0.1:5432:5432 -e POSTGRES_HOST_AUTH_METHOD=trust --name pg11 postgres:11
      #- export PGHOST="localhost"
      #- export PGUSER="postgres"
    - bundle exec rake setup
  - stage: ":ship: it to quay.io"
    addons:
      snaps:
      - name: docker
        channel: latest/beta
    language: bash
    script: make ship
    if: (branch = master and type = push ) OR commit_message =~ /ship:docker/ OR env(SHIP_DOCKER) = true
